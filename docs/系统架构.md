# 系统架构详解

## 概述

本文档详细说明 LinkForge MJCF 约束生成系统的整体架构，包括各个智能体的职责、能力、数据流、记忆存储、使用的数据模型和 Prompt 设计。

## 项目结构

```
LinkForge/
├── agent/                          # 核心智能体模块
│   ├── __init__.py                 # 模块导出
│   ├── render_orchestrator.py     # 渲染编排智能体
│   ├── scene_awareness_agent.py   # 场景感知智能体
│   ├── constraint_reasoning_agent.py  # 约束推理智能体
│   ├── mjcf_constraint_agent.py   # MJCF约束生成智能体
│   ├── memory.py                  # 记忆系统
│   ├── tools/                     # 工具模块
│   │   ├── base_tool.py          # 工具基类
│   │   ├── render_tools.py       # 渲染工具
│   │   ├── analysis_tools.py     # 分析工具
│   │   └── constraint_analysis_tools.py  # 约束分析工具
│   └── utils/                     # 工具函数
│       ├── data_models.py         # 数据模型定义
│       ├── mjcf_constraint_models.py  # MJCF约束模型
│       ├── prompt_templates.py    # Prompt模板
│       ├── llm_utils.py           # LLM工具函数
│       ├── env_utils.py           # 环境变量工具
│       ├── image_utils.py         # 图像处理工具
│       ├── mesh_analyzer.py       # Mesh几何分析器
│       ├── render_controller.py  # MuJoCo渲染控制器
│       └── user_hint_parser.py    # 用户提示解析器
├── DEMO/                          # 演示程序
│   └── main.py                    # 主程序入口
├── docs/                          # 文档
│   └── MJCF约束生成系统/
│       └── 00-系统架构详解.md     # 本文档
├── Examples/                       # 示例模型
├── scene_memory/                  # 记忆存储目录（运行时生成）
├── .env.example                   # 环境变量配置模板
├── .gitignore                     # Git忽略文件
└── README.md                      # 项目说明
```

## 主程序入口

主程序位于 `DEMO/main.py`，展示了完整的工作流程：

1. **初始化智能体**：创建所有需要的智能体实例
2. **渲染编排**：渲染整体场景和部件高亮图像
3. **用户提示**：交互式获取用户提示（可选）
4. **场景分析**：分析场景和所有部件
5. **约束推理**：为运动部件推理运动约束
6. **MJCF生成**：生成MJCF格式的约束并写入XML文件

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         MJCF约束生成系统架构                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                        渲染编排智能体 (RenderOrchestrator)              │ │
│  │  ┌────────────────────────────────────────────────────────────────┐ │ │
│  │  │ 能力：                                                           │ │ │
│  │  │  - 多线程渲染管理                                                │ │ │
│  │  │  - 整体场景渲染（9视角马赛克）                                    │ │ │
│  │  │  - 部件高亮渲染（并行）                                           │ │ │
│  │  │  - 颜色映射生成                                                  │ │ │
│  │  └────────────────────────────────────────────────────────────────┘ │ │
│  │  ┌────────────────────────────────────────────────────────────────┐ │ │
│  │  │ 输入：                                                           │ │ │
│  │  │  - xml_path: MJCF XML文件路径                                   │ │ │
│  │  │  - max_workers: 最大线程数                                       │ │ │
│  │  └────────────────────────────────────────────────────────────────┘ │ │
│  │  ┌────────────────────────────────────────────────────────────────┐ │ │
│  │  │ 输出到记忆系统：                                                 │ │ │
│  │  │  - overall渲染结果：                                            │ │ │
│  │  │    * image_path: "overall_{场景名}.png"                          │ │ │
│  │  │    * rendering_type: "overall"                                  │ │ │
│  │  │    * xml_path, timestamp                                        │ │ │
│  │  │  - part高亮渲染结果（每个part）：                                 │ │ │
│  │  │    * part_name, image_path: "highlighted_{part_name}.png"       │ │ │
│  │  │    * rendering_type: "part_highlighted"                          │ │ │
│  │  │    * color_mapping: {颜色hex: {rgb, index, ...}}                │ │ │
│  │  │    * xml_path, timestamp                                        │ │ │
│  │  └────────────────────────────────────────────────────────────────┘ │ │
│  │  ┌────────────────────────────────────────────────────────────────┐ │ │
│  │  │ 使用的工具/模块：                                                 │ │ │
│  │  │  - MujocoRenderController: 渲染控制器                            │ │ │
│  │  │  - MemoryManager: 记忆管理器                                      │ │ │
│  │  └────────────────────────────────────────────────────────────────┘ │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                              │                                              │
│                              ▼                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                      场景感知智能体 (SceneAwarenessAgent)              │ │
│  │  ┌────────────────────────────────────────────────────────────────┐ │ │
│  │  │ 能力：                                                           │ │ │
│  │  │  - LLM视觉分析（多模态：图像+文本）                               │ │ │
│  │  │  - 场景级别理解（设备类型、功能、复杂度）                          │ │ │
│  │  │  - 部件级别分析（功能、位置、运动类型、语义信息）                  │ │ │
│  │  │  - 用户提示处理（优先级最高）                                      │ │ │
│  │  │  - 多线程并行分析                                                 │ │ │
│  │  └────────────────────────────────────────────────────────────────┘ │ │
│  │  ┌────────────────────────────────────────────────────────────────┐ │ │
│  │  │ 输入：                                                           │ │ │
│  │  │  - xml_path: XML文件路径                                         │ │ │
│  │  │  - user_hints: 用户提示字典（可选）                               │ │ │
│  │  │  - 从记忆系统读取：overall图像、part高亮图像                       │ │ │
│  │  └────────────────────────────────────────────────────────────────┘ │ │
│  │  ┌────────────────────────────────────────────────────────────────┐ │ │
│  │  │ 输出到记忆系统：                                                 │ │ │
│  │  │  - 场景描述（memory_category: "scene_description"）：            │ │ │
│  │  │    * 场景总结：设备类型、主要功能、组件数量、复杂度               │ │ │
│  │  │    * 详细场景描述：LLM生成的完整描述                              │ │ │
│  │  │    * metadata: device_type, main_function, total_components,   │ │ │
│  │  │      complexity_level, motion_parts, fixed_parts, key_features  │ │ │
│  │  │  - 场景分析结果（memory_category: "scene_analysis"）：          │ │ │
│  │  │    * 结构化场景信息                                              │ │ │
│  │  │    * metadata: xml_path, image_path, device_type, ...           │ │ │
│  │  │  - Part分析结果（analysis_type: "part_analysis"）：             │ │ │
│  │  │    * 每个part的详细分析文本                                      │ │ │
│  │  │    * metadata: part_name, function, motion_type, position,     │ │ │
│  │  │      material, confidence, image_path                          │ │ │
│  │  └────────────────────────────────────────────────────────────────┘ │ │
│  │  ┌────────────────────────────────────────────────────────────────┐ │ │
│  │  │ 使用的DataModels：                                               │ │ │
│  │  │  - PartAnalysisResult: 单个part分析结果                          │ │ │
│  │  │  - ScenePartAnalysisResult: 所有part分析结果                     │ │ │
│  │  │  - PartAnalysisLLMResponse: LLM输出的结构化响应                  │ │ │
│  │  │  - PartMotionTypeResponse: 快速运动类型分析响应                   │ │ │
│  │  └────────────────────────────────────────────────────────────────┘ │ │
│  │  ┌────────────────────────────────────────────────────────────────┐ │ │
│  │  │ 使用的Prompt模板：                                                │ │ │
│  │  │  - build_scene_analysis_prompt(): 场景分析提示                    │ │ │
│  │  │    * 任务：分析整体场景，识别设备类型、主要功能、组件等            │ │ │
│  │  │    * 输出：场景描述文本                                           │ │ │
│  │  │  - build_part_analysis_prompt(): Part分析提示                     │ │ │
│  │  │    * 任务：分析特定部件，识别功能、位置、运动类型、语义信息         │ │ │
│  │  │    * 输入：part_name, scene_info, scene_description, color_mapping│ │ │
│  │  │    * 输出：PartAnalysisLLMResponse（结构化）                       │ │ │
│  │  │  - build_part_motion_type_prompt(): Part运动类型分析提示           │ │ │
│  │  │    * 任务：快速识别部件的运动类型（fixed/sliding/rotating）        │ │ │
│  │  │    * 输出：PartMotionTypeResponse（简化）                         │ │ │
│  │  └────────────────────────────────────────────────────────────────┘ │ │
│  │  ┌────────────────────────────────────────────────────────────────┐ │ │
│  │  │ 使用的工具/模块：                                                 │ │ │
│  │  │  - LLM (build_llm): 大语言模型                                   │ │ │
│  │  │  - describe_image: 单图像分析                                     │ │ │
│  │  │  - describe_multiple_images: 多图像分析                           │ │ │
│  │  │  - RenderOrchestrator: 加载渲染结果                               │ │ │
│  │  │  - MemoryManager: 记忆管理器                                      │ │ │
│  │  │  - UserHintParser: 用户提示解析（可选）                           │ │ │
│  │  └────────────────────────────────────────────────────────────────┘ │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                              │                                              │
│                              ▼                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                     约束推理智能体 (ConstraintReasoningAgent)          │ │
│  │  ┌────────────────────────────────────────────────────────────────┐ │ │
│  │  │ 能力：                                                           │ │ │
│  │  │  - 运动约束推理（滑动方向、旋转轴、运动范围）                      │ │ │
│  │  │  - 几何分析工具集成（生成候选轴/方向）                             │ │ │
│  │  │  - LLM轴选择（从候选中选择最合适的）                               │ │ │
│  │  │  - 空间上下文分析（开口方向、相邻部件）                            │ │ │
│  │  │  - 用户提示处理（优先级最高）                                      │ │ │
│  │  └────────────────────────────────────────────────────────────────┘ │ │
│  │  ┌────────────────────────────────────────────────────────────────┐ │ │
│  │  │ 输入：                                                           │ │ │
│  │  │  - part_name: 部件名称                                           │ │ │
│  │  │  - part_analysis: PartAnalysisResult（从SceneAwarenessAgent）    │ │ │
│  │  │  - user_hints: 用户提示字典（可选）                               │ │ │
│  │  │  - 从记忆系统读取：overall图像、part高亮图像、场景描述             │ │ │
│  │  └────────────────────────────────────────────────────────────────┘ │ │
│  │  ┌────────────────────────────────────────────────────────────────┐ │ │
│  │  │ 输出到记忆系统：                                                 │ │ │
│  │  │  - 可视化图像（visualization_type: "axis_analysis"）：           │ │ │
│  │  │    * part_name, motion_type                                     │ │ │
│  │  │    * visualization_path: "{part_name}_{motion_type}.png"        │ │ │
│  │  │    * 带颜色编码的可视化图像（候选轴/方向）                         │ │ │
│  │  └────────────────────────────────────────────────────────────────┘ │ │
│  │  ┌────────────────────────────────────────────────────────────────┐ │ │
│  │  │ 使用的DataModels：                                               │ │ │
│  │  │  - MotionConstraintResult: 运动约束推理结果                      │ │ │
│  │  │  - MotionConstraintLLMResponse: LLM约束推理响应                  │ │ │
│  │  │  - AxisSelectionLLMResponse: LLM轴选择响应                        │ │ │
│  │  │  - PartAnalysisResult: Part分析结果（输入）                      │ │ │
│  │  └────────────────────────────────────────────────────────────────┘ │ │
│  │  ┌────────────────────────────────────────────────────────────────┐ │ │
│  │  │ 使用的Prompt模板：                                                │ │ │
│  │  │  - build_sliding_constraint_prompt(): 滑动约束推理提示            │ │ │
│  │  │    * 任务：推理滑动部件的滑动方向和运动范围                        │ │ │
│  │  │    * 输入：part_name, part_analysis, scene_description, aabb_info│ │ │
│  │  │    * 输出：MotionConstraintLLMResponse                            │ │ │
│  │  │  - build_rotating_constraint_prompt(): 旋转约束推理提示          │ │ │
│  │  │    * 任务：推理旋转部件的旋转类型、轴位置、运动范围                │ │ │
│  │  │    * 输入：part_name, part_analysis, scene_description, aabb_info│ │ │
│  │  │    * 输出：MotionConstraintLLMResponse                            │ │ │
│  │  │  - build_axis_selection_prompt(): 轴选择提示                      │ │ │
│  │  │    * 任务：从候选轴/方向列表中选择最合适的                         │ │ │
│  │  │    * 输入：part_name, candidate_axes, visualization_path,        │ │ │
│  │  │      scene_description, spatial_context, index_mapping           │ │ │
│  │  │    * 输出：AxisSelectionLLMResponse（selected_axis_id, index）    │ │ │
│  │  └────────────────────────────────────────────────────────────────┘ │ │
│  │  ┌────────────────────────────────────────────────────────────────┐ │ │
│  │  │ 使用的工具/模块：                                                 │ │ │
│  │  │  - AnalyzeMotionTypeTool: 运动类型分析工具                       │ │ │
│  │  │    * 滑动方向分析：AnalyzeSlidingDirectionTool                   │ │ │
│  │  │    * 边缘旋转分析：FindPartEdgesTool                             │ │ │
│  │  │    * 中心线旋转分析：FindCenterlineAxesTool                       │ │ │
│  │  │  - LLM: 大语言模型                                               │ │ │
│  │  │  - RenderOrchestrator: 加载渲染结果                               │ │ │
│  │  │  - MemoryManager: 记忆管理器                                      │ │ │
│  │  │  - MeshAnalyzer: Mesh几何分析器                                   │ │ │
│  │  └────────────────────────────────────────────────────────────────┘ │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                              │                                              │
│                              ▼                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                    MJCF约束生成智能体 (MJCFConstraintAgent)            │ │
│  │  ┌────────────────────────────────────────────────────────────────┐ │ │
│  │  │ 能力：                                                           │ │ │
│  │  │  - MJCF格式转换（约束结果 → MJCF元素）                            │ │ │
│  │  │  - XML文件修改（添加joint、site、equality、actuator）             │ │ │
│  │  │  - 坐标系统处理（mesh中心、body位置、joint位置）                  │ │ │
│  │  │  - 角度单位处理（度数/弧度转换）                                  │ │ │
│  │  └────────────────────────────────────────────────────────────────┘ │ │
│  │  ┌────────────────────────────────────────────────────────────────┐ │ │
│  │  │ 输入：                                                           │ │ │
│  │  │  - xml_path: 原始XML文件路径                                     │ │ │
│  │  │  - constraint_results: MotionConstraintResult列表                │ │ │
│  │  │  - output_path: 输出XML文件路径（可选）                           │ │ │
│  │  └────────────────────────────────────────────────────────────────┘ │ │
│  │  ┌────────────────────────────────────────────────────────────────┐ │ │
│  │  │ 输出：                                                           │ │ │
│  │  │  - 修改后的XML文件（包含joint、actuator等）                       │ │ │
│  │  │  - MJCFGenerationResult: 生成结果                                │ │ │
│  │  │    * constraint_plans: MJCFConstraintPlan列表                    │ │ │
│  │  │    * modifications: 修改说明列表                                 │ │ │
│  │  └────────────────────────────────────────────────────────────────┘ │ │
│  │  ┌────────────────────────────────────────────────────────────────┐ │ │
│  │  │ 使用的DataModels：                                               │ │ │
│  │  │  - MJCFConstraintPlan: MJCF约束方案                               │ │ │
│  │  │  - MJCFJointSpec: MJCF关节规格                                    │ │ │
│  │  │  - MJCFSiteSpec: MJCF站点规格（可选）                             │ │ │
│  │  │  - MJCFEqualityConstraintSpec: MJCF等式约束规格（可选）           │ │ │
│  │  │  - MJCFGenerationResult: MJCF生成结果                             │ │ │
│  │  │  - MotionConstraintResult: 运动约束结果（输入）                    │ │ │
│  │  └────────────────────────────────────────────────────────────────┘ │ │
│  │  ┌────────────────────────────────────────────────────────────────┐ │ │
│  │  │ 使用的工具/模块：                                                 │ │ │
│  │  │  - MeshAnalyzer: Mesh几何分析器（计算mesh中心）                   │ │ │
│  │  │  - xml.etree.ElementTree: XML解析和修改                           │ │ │
│  │  └────────────────────────────────────────────────────────────────┘ │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                        记忆系统 (Memory System)                         │ │
│  │  ┌────────────────────────────────────────────────────────────────┐ │ │
│  │  │ 存储内容：                                                       │ │ │
│  │  │  - 渲染结果（rendering_type标记）：                              │ │ │
│  │  │    * overall渲染：overall图像路径、类型、时间戳                  │ │ │
│  │  │    * part高亮渲染：part名称、图像路径、颜色映射、时间戳           │ │ │
│  │  │  - 场景分析结果（memory_category标记）：                          │ │ │
│  │  │    * 场景描述：总结+详细描述、设备类型、组件数量等                │ │ │
│  │  │    * 场景分析：结构化场景信息                                    │ │ │
│  │  │  - Part分析结果（analysis_type标记）：                           │ │ │
│  │  │    * 每个part的详细分析、功能、运动类型、置信度等                 │ │ │
│  │  │  - 可视化结果（visualization_type标记）：                         │ │ │
│  │  │    * 运动轴可视化图像路径、运动类型                               │ │ │
│  │  └────────────────────────────────────────────────────────────────┘ │ │
│  │  ┌────────────────────────────────────────────────────────────────┐ │ │
│  │  │ 检索机制：                                                       │ │ │
│  │  │  - 按关键词检索（简单匹配）                                       │ │ │
│  │  │  - 按metadata字段过滤（rendering_type, memory_category等）      │ │ │
│  │  │  - 按时间戳排序（最新的在前）                                      │ │ │
│  │  │  - 验证文件存在性                                                 │ │ │
│  │  └────────────────────────────────────────────────────────────────┘ │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                        支撑模块                                        │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │ │
│  │  │ 用户提示解析 │  │  数据模型    │  │   工具模块    │             │ │
│  │  │UserHintParser│  │ DataModels  │  │    Tools     │             │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘             │ │
│  │                                                                     │ │
│  │  ┌──────────────────────────────────────────────────────────────┐ │ │
│  │  │ 用户提示解析 (UserHintParser)                                 │ │ │
│  │  │  - 能力：自然语言解析、视觉匹配、约束信息提取                  │ │ │
│  │  │  - 输入：user_hint文本、part_images、overall_image            │ │ │
│  │  │  - 输出：{part_name: {motion_type, sliding_direction, ...}}  │ │ │
│  │  │  - 使用的DataModel: UserHintParsedResult                       │ │ │
│  │  └──────────────────────────────────────────────────────────────┘ │ │
│  │                                                                     │ │
│  │  ┌──────────────────────────────────────────────────────────────┐ │ │
│  │  │ 数据模型 (DataModels)                                         │ │ │
│  │  │  - PartAnalysisResult: Part分析结果                           │ │ │
│  │  │  - ScenePartAnalysisResult: 场景Part分析结果                   │ │ │
│  │  │  - MotionConstraintResult: 运动约束结果                        │ │ │
│  │  │  - MJCFConstraintPlan: MJCF约束方案                           │ │ │
│  │  │  - 各种LLM响应模型（PartAnalysisLLMResponse等）                │ │ │
│  │  └──────────────────────────────────────────────────────────────┘ │ │
│  │                                                                     │ │
│  │  ┌──────────────────────────────────────────────────────────────┐ │ │
│  │  │ 工具模块 (Tools)                                               │ │ │
│  │  │  - AnalyzeMotionTypeTool: 综合分析工具                         │ │ │
│  │  │  - AnalyzeSlidingDirectionTool: 滑动方向分析                    │ │ │
│  │  │  - FindPartEdgesTool: 边缘查找                                 │ │ │
│  │  │  - FindCenterlineAxesTool: 中心线查找                           │ │ │
│  │  │  - 输出：候选轴/方向列表、颜色映射、序号映射、可视化图像         │ │ │
│  │  └──────────────────────────────────────────────────────────────┘ │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 数据流详解

### 完整数据流

```
1. 输入阶段
   XML文件
   ↓
   RenderOrchestrator
   ↓
   渲染图像（overall + part高亮）
   ↓
   记忆系统存储

2. 场景感知阶段
   从记忆系统读取渲染图像
   ↓
   SceneAwarenessAgent
   ↓
   场景分析 + Part分析
   ↓
   记忆系统存储（场景描述、Part分析结果）

3. 约束推理阶段
   从记忆系统读取Part分析结果
   ↓
   ConstraintReasoningAgent
   ↓
   工具分析（生成候选轴/方向）
   ↓
   LLM选择（从候选中选择）
   ↓
   MotionConstraintResult
   ↓
   记忆系统存储（可视化图像）

4. MJCF生成阶段
   MotionConstraintResult列表
   ↓
   MJCFConstraintAgent
   ↓
   MJCF格式转换
   ↓
   修改XML文件
   ↓
   输出XML文件
```

## 各智能体详细说明

### 1. RenderOrchestrator（渲染编排智能体）

#### 核心职责
- 管理渲染任务的编排和调度
- 为场景和所有部件生成可视化图像

#### 主要能力
1. **多线程渲染管理**
   - 使用ThreadPoolExecutor管理并行渲染
   - 支持配置最大线程数（默认4）

2. **整体场景渲染**
   - 渲染3D模型的9视角马赛克图（3x3）
   - 不设置高亮，展示原始场景

3. **部件高亮渲染**
   - 为每个部件生成单独的高亮渲染图
   - 每个部件分配唯一颜色
   - 并行渲染多个部件

4. **颜色映射生成**
   - 记录每个部件的颜色信息（hex、rgb、index）
   - 用于后续的可视化识别

#### 存储到记忆系统的信息

**Overall渲染结果**：
```python
{
    "content": "Overall渲染结果：\n- 图像路径：overall_xxx.png\n- 图像类型：overall",
    "metadata": {
        "xml_path": "xxx.xml",
        "image_path": "overall_xxx.png",
        "image_type": "overall",
        "rendering_type": "overall",  # 标记为overall渲染
        "image_name": "overall",      # 用于检索
        "timestamp": 1234567890.0
    }
}
```

**Part高亮渲染结果**（每个part）：
```python
{
    "content": "Part高亮渲染结果 - door0：\n- Part名称：door0\n- 图像路径：highlighted_door0.png\n- 颜色映射：{...}",
    "metadata": {
        "xml_path": "xxx.xml",
        "part_name": "door0",
        "image_path": "highlighted_door0.png",
        "image_type": "highlighted",
        "rendering_type": "part_highlighted",  # 标记为part高亮渲染
        "image_name": "highlighted_door0",     # 用于检索
        "color_mapping": {                      # 颜色映射
            "#FF0000": {
                "hex": "#FF0000",
                "rgb": [255, 0, 0],
                "index": 0
            },
            ...
        },
        "timestamp": 1234567890.0
    }
}
```

#### 调用的能力/工具
- **MujocoRenderController**: MuJoCo渲染控制器
  - `render_original()`: 渲染原始场景（9视角马赛克）
  - `render()`: 渲染高亮场景（9视角马赛克）
  - `set_highlights()`: 设置高亮部件
  - `get_highlight_color_mapping()`: 获取颜色映射

- **MemoryManager**: 记忆管理器
  - `store_long()`: 存储长记忆
  - `retrieve()`: 检索记忆

#### 使用的DataModels
- 无（直接使用字典和元数据）

---

### 2. SceneAwarenessAgent（场景感知智能体）

#### 核心职责
- 理解场景的整体结构
- 分析各个部件的详细信息
- 识别运动部件和固定部件

#### 主要能力
1. **场景级别分析**
   - 使用LLM分析整体场景图像
   - 提取设备类型、主要功能、组件数量等宏观信息

2. **部件级别分析**
   - 结合overall图像和part高亮图像
   - 分析部件功能、位置、运动类型、语义信息

3. **用户提示处理**
   - 解析用户提供的自然语言提示
   - 用户提示的运动类型具有最高优先级（置信度1.0）

4. **多线程并行分析**
   - 并行分析多个部件，提高效率

#### 存储到记忆系统的信息

**场景描述**（memory_category: "scene_description"）：
```python
{
    "content": "场景总结：\n- 设备类型：冰箱\n- 主要功能：冷藏\n- 组件数量：5\n- 复杂度：中等\n- 运动部件：door0, door1\n\n详细场景描述：\n[LLM生成的完整描述]",
    "metadata": {
        "memory_category": "scene_description",
        "memory_type": "scene_description",
        "is_valid": True,
        "xml_path": "xxx.xml",
        "image_path": "overall_xxx.png",
        "device_type": "冰箱",
        "main_function": "冷藏",
        "total_components": 5,
        "complexity_level": "中等",
        "motion_parts": ["door0", "door1"],
        "fixed_parts": ["main"],
        "key_features": ["旋转运动", "铰链连接"],
        "task_instruction": "",
        "timestamp": 1234567890.0
    }
}
```

**场景分析结果**（memory_category: "scene_analysis"）：
```python
{
    "content": "场景分析结果：\n- 设备类型：冰箱\n- 主要功能：冷藏\n- 组件数量：5\n- 复杂度：中等\n\n详细分析：\n[LLM生成的完整分析]",
    "metadata": {
        "memory_category": "scene_analysis",
        "xml_path": "xxx.xml",
        "image_path": "overall_xxx.png",
        "device_type": "冰箱",
        "total_components": 5,
        "complexity_level": "中等",
        "task_instruction": "",
        "timestamp": 1234567890.0
    }
}
```

**Part分析结果**（analysis_type: "part_analysis"）：
```python
{
    "content": "Part分析结果 - door0：\n- 功能：门\n- 运动类型：rotating\n- 位置：前面\n- 材质：金属\n- 置信度：0.9\n\n详细语义信息：\n- 详细位置：冰箱前面左侧\n- 具体功能：冷藏室门\n- 运动描述：绕垂直边缘旋转打开\n- 交互方式：拉手\n- 连接方式：铰链\n\n详细分析：\n[LLM生成的完整分析]",
    "metadata": {
        "part_name": "door0",
        "analysis_type": "part_analysis",
        "function": "门",
        "motion_type": "rotating",
        "position": "前面",
        "material": "金属",
        "confidence": 0.9,
        "image_path": "highlighted_door0.png",
        "timestamp": 1234567890.0
    }
}
```

#### 调用的能力/工具
- **LLM (build_llm)**: 大语言模型
  - `describe_image()`: 单图像分析
  - `describe_multiple_images()`: 多图像分析

- **RenderOrchestrator**: 加载渲染结果
  - `load_rendering_results_from_memory()`: 从记忆系统加载渲染图像

- **MemoryManager**: 记忆管理器
  - `store_long()`: 存储长记忆
  - `retrieve()`: 检索记忆

- **UserHintParser**（可选）: 用户提示解析
  - `get_user_hints_interactive()`: 交互式获取用户提示

#### 使用的DataModels

**输入/输出模型**：
- `PartAnalysisResult`: 单个part分析结果
- `ScenePartAnalysisResult`: 所有part分析结果

**LLM响应模型**：
- `PartAnalysisLLMResponse`: Part分析的完整LLM响应
- `PartMotionTypeResponse`: 快速运动类型分析的简化响应

#### 使用的Prompt模板

**build_scene_analysis_prompt()**:
```
任务：分析整体场景图像，识别：
1. 设备类型（如：冰箱、柜子、桌子等）
2. 主要功能
3. 组件数量和类型
4. 复杂度评估
5. 关键特征（旋转运动、滑动运动等）

输出：详细的场景描述文本
```

**build_part_analysis_prompt()**:
```
任务：分析特定部件（结合overall图像和part高亮图像），识别：
1. 部件功能
2. 运动类型（fixed/sliding/rotating）
3. 位置描述
4. 材质
5. 详细语义信息：
   - 详细位置
   - 具体功能
   - 运动描述
   - 交互方式
   - 连接方式
   - 重要性级别

输入上下文：
- part_name: 部件名称
- scene_info: 场景信息
- scene_description: 场景描述
- color_mapping: 颜色映射

输出：PartAnalysisLLMResponse（结构化）
```

**build_part_motion_type_prompt()**:
```
任务：快速识别部件的运动类型（仅返回motion_type）

输出：PartMotionTypeResponse（简化，仅包含motion_type、confidence、brief_reasoning）
```

---

### 3. ConstraintReasoningAgent（约束推理智能体）

#### 核心职责
- 为运动部件推理具体的运动约束参数
- 确定滑动方向、旋转轴、运动范围等

#### 主要能力
1. **滑动约束推理**
   - 调用工具分析所有可能的滑动方向候选
   - 使用LLM从候选中选择最合适的

2. **旋转约束推理**
   - 判断旋转类型（edge或centerline）
   - 调用工具分析所有可能的旋转轴候选
   - 使用LLM从候选中选择最合适的

3. **空间上下文分析**
   - 分析部件的开口方向（往外/往里）
   - 考虑相邻部件的位置关系
   - 使用AABB信息辅助分析

4. **运动范围推理**
   - 滑动：距离（米），默认±0.4米
   - 旋转：角度（度），默认±90度

#### 存储到记忆系统的信息

**可视化图像**（visualization_type: "axis_analysis"）：
```python
{
    "content": "运动轴可视化结果 - door0：\n- Part名称：door0\n- 运动类型：edge_rotation\n- 可视化图像路径：door0_edge_rotation.png",
    "metadata": {
        "part_name": "door0",
        "motion_type": "edge_rotation",
        "visualization_path": "door0_edge_rotation.png",
        "visualization_type": "axis_analysis",
        "image_name": "visualization_door0_edge_rotation",
        "timestamp": 1234567890.0
    }
}
```

#### 调用的能力/工具

**AnalyzeMotionTypeTool**: 综合分析工具
- **滑动方向分析**（motion_type="sliding"）:
  - 调用 `AnalyzeSlidingDirectionTool`
  - 分析mesh几何特征，计算所有可能的滑动方向（X/Y/Z轴）
  - 生成可视化图像（带颜色编码）

- **边缘旋转分析**（motion_type="edge_rotation"）:
  - 调用 `FindPartEdgesTool`
  - 分析mesh边缘，计算对齐分数
  - 生成可视化图像

- **中心线旋转分析**（motion_type="centerline_rotation"）:
  - 调用 `FindCenterlineAxesTool`
  - 分析mesh中心线（AABB中心、质心等）
  - 生成可视化图像

**工具输出结构**：
```python
{
    "success": True,
    "data": {
        "directions": [...],  # 或 "axes": [...]
        "color_mapping": {...},
        "index_mapping": {...},
        "visualization_path": "xxx.png",
        "mesh_info_dict": {...}
    }
}
```

**LLM**: 大语言模型
- `describe_multiple_images()`: 多图像分析（overall + part高亮 + 可视化）

**RenderOrchestrator**: 加载渲染结果
- `load_rendering_results_from_memory()`: 从记忆系统加载渲染图像

**MemoryManager**: 记忆管理器
- `store_long()`: 存储可视化图像路径
- `retrieve()`: 检索场景描述、part分析结果

**MeshAnalyzer**: Mesh几何分析器
- 通过工具间接使用，获取mesh的AABB信息

#### 使用的DataModels

**输入模型**：
- `PartAnalysisResult`: Part分析结果（从SceneAwarenessAgent）

**输出模型**：
- `MotionConstraintResult`: 运动约束推理结果

**LLM响应模型**：
- `MotionConstraintLLMResponse`: 约束推理的LLM响应
- `AxisSelectionLLMResponse`: 轴选择的LLM响应

#### 使用的Prompt模板

**build_sliding_constraint_prompt()**:
```
任务：推理滑动部件的滑动方向和运动范围

输入上下文：
- part_name: 部件名称
- part_analysis: Part分析结果
- scene_description: 场景描述
- aabb_info: AABB信息（可选）

输出：MotionConstraintLLMResponse
- sliding_direction: x/y/z
- sliding_orientation: 详细描述
- motion_range: 运动范围值（米，单个值，系统会转换为对称范围）
- motion_range_description: 范围描述
- confidence: 置信度
- reasoning: 推理过程
```

**build_rotating_constraint_prompt()**:
```
任务：推理旋转部件的旋转类型、轴位置和运动范围

输入上下文：
- part_name: 部件名称
- part_analysis: Part分析结果
- scene_description: 场景描述
- aabb_info: AABB信息（可选）

输出：MotionConstraintLLMResponse
- rotation_type: centerline/edge/custom_axis
- axis_description: 轴描述
- axis_location: 轴位置描述
- motion_range: 运动范围值（度，单个值，系统会转换为对称范围）
- motion_range_description: 范围描述
- confidence: 置信度
- reasoning: 推理过程
```

**build_axis_selection_prompt()**:
```
任务：从候选轴/方向列表中选择最合适的

输入上下文：
- part_name: 部件名称
- part_analysis: Part分析结果
- candidate_axes: 候选轴/方向列表（带序号）
- motion_type: 运动类型
- visualization_path: 可视化图像路径
- scene_description: 场景描述
- aabb_info: AABB信息
- spatial_context: 空间上下文（开口方向、相邻部件等）
- index_mapping: 序号映射（用于将序号转换为轴ID）

候选列表格式：
序号 0: {轴信息}
序号 1: {轴信息}
...

输出：AxisSelectionLLMResponse
- selected_axis_id: 选中的轴ID
- selected_index: 选中的序号
- confidence: 选择置信度
- reasoning: 选择推理过程
- alternative_axis_ids: 备选轴ID列表（可选）
```

---

### 4. MJCFConstraintAgent（MJCF约束生成智能体）

#### 核心职责
- 将约束推理结果转换为MJCF格式
- 修改XML文件，添加约束元素

#### 主要能力
1. **约束方案转换**
   - 将MotionConstraintResult转换为MJCFConstraintPlan
   - 为滑动创建slide joint
   - 为旋转创建hinge joint

2. **XML文件修改**
   - 查找part对应的geom和body
   - 为part创建独立的body（如果还没有）
   - 添加joint、actuator等元素

3. **坐标系统处理**
   - 计算mesh中心位置
   - 调整body位置以保持几何正确
   - 调整joint位置（相对于body坐标系）

4. **角度单位处理**
   - 设置compiler angle="degree"
   - 直接使用度数（MuJoCo自动转换为弧度）

#### 存储到记忆系统的信息
- 无（不存储到记忆系统，直接输出XML文件）

#### 调用的能力/工具

**MeshAnalyzer**: Mesh几何分析器
- `analyze()`: 分析mesh，获取AABB中心
- 用于计算body位置和joint位置调整

**xml.etree.ElementTree**: XML解析和修改
- `parse()`: 解析XML文件
- `find()`: 查找元素
- `SubElement()`: 创建子元素
- `set()`: 设置属性

#### 使用的DataModels

**输入模型**：
- `MotionConstraintResult`: 运动约束结果（从ConstraintReasoningAgent）

**输出模型**：
- `MJCFConstraintPlan`: MJCF约束方案
- `MJCFJointSpec`: MJCF关节规格
- `MJCFSiteSpec`: MJCF站点规格（可选）
- `MJCFEqualityConstraintSpec`: MJCF等式约束规格（可选）
- `MJCFGenerationResult`: MJCF生成结果

**枚举类型**：
- `JointType`: 关节类型（SLIDE, HINGE, BALL, FREE）

---

## 记忆系统详解

### 记忆分类

记忆系统通过metadata字段对记忆进行分类：

| metadata字段 | 值 | 说明 |
|-------------|-----|------|
| `rendering_type` | `"overall"` | Overall渲染结果 |
| `rendering_type` | `"part_highlighted"` | Part高亮渲染结果 |
| `memory_category` | `"scene_description"` | 场景描述 |
| `memory_category` | `"scene_analysis"` | 场景分析结果 |
| `analysis_type` | `"part_analysis"` | Part分析结果 |
| `visualization_type` | `"axis_analysis"` | 运动轴可视化结果 |

### 记忆检索策略

1. **按类型检索**：
   ```python
   memories = memory.retrieve("场景描述", memory_type="long", limit=10)
   scene_descriptions = [
       m for m in memories 
       if m.metadata.get("memory_category") == "scene_description"
   ]
   ```

2. **按部件名称检索**：
   ```python
   memories = memory.retrieve(f"Part分析结果 - {part_name}", memory_type="long", limit=10)
   ```

3. **按时间戳排序**：
   ```python
   memories.sort(key=lambda x: x.timestamp, reverse=True)
   latest_memory = memories[0]
   ```

4. **验证文件存在**：
   ```python
   for memory in memories:
       image_path = memory.metadata.get("image_path")
       if image_path and Path(image_path).exists():
           # 使用这个记忆
           break
   ```

---

## 支撑模块详解

### 1. UserHintParser（用户提示解析）

#### 能力
- 自然语言解析
- 视觉匹配（通过比较部件图像）
- 约束信息提取

#### 输入
- `user_hint`: 用户自然语言提示（如："门是旋转打开的"）
- `part_images`: 部件名称到图片路径的字典
- `overall_image_path`: 整体场景图片路径（可选）

#### 输出
```python
{
    "door0": {
        "motion_type": "rotating",
        "rotation_type": "edge",
        "motion_range": 90.0
    }
}
```

#### 使用的DataModel
- `UserHintParsedResult`: 用户提示解析结果

#### 工作原理
1. 构建prompt，包含用户提示和所有部件列表
2. 使用LLM分析所有部件的高亮图像
3. 通过视觉比较匹配用户描述的部件
4. 提取运动类型、方向、范围等约束信息
5. 支持模糊匹配（如果精确匹配失败）

---

### 2. DataModels（数据模型）

#### 核心数据模型

**分析阶段**：
- `PartAnalysisResult`: 单个part分析结果
- `ScenePartAnalysisResult`: 所有part分析结果

**约束推理阶段**：
- `MotionConstraintResult`: 运动约束推理结果

**MJCF生成阶段**：
- `MJCFConstraintPlan`: MJCF约束方案
- `MJCFJointSpec`: MJCF关节规格
- `MJCFGenerationResult`: MJCF生成结果

**LLM响应模型**：
- `PartAnalysisLLMResponse`: Part分析的LLM响应
- `MotionConstraintLLMResponse`: 约束推理的LLM响应
- `AxisSelectionLLMResponse`: 轴选择的LLM响应
- `PartMotionTypeResponse`: 快速运动类型分析的响应
- `UserHintParsedResult`: 用户提示解析结果

**枚举类型**：
- `PartMotionType`: 部件运动类型（FIXED, ROTATING, SLIDING, UNKNOWN）
- `RotationType`: 旋转类型（CENTERLINE, EDGE, CUSTOM_AXIS）
- `SlidingDirectionType`: 滑动方向类型（X_AXIS, Y_AXIS, Z_AXIS）
- `JointType`: 关节类型（SLIDE, HINGE, BALL, FREE）

---

### 3. Tools（工具模块）

#### 核心工具

**AnalyzeMotionTypeTool**: 综合分析工具
- 根据运动类型调用相应的子工具
- 生成可视化图像（带颜色编码）
- 返回候选轴/方向列表、颜色映射、序号映射

**AnalyzeSlidingDirectionTool**: 滑动方向分析
- 分析所有可能的滑动方向（X/Y/Z轴）
- 输出方向向量、轴名称、描述等

**FindPartEdgesTool**: 边缘查找
- 分析mesh边缘
- 计算对齐分数（与主轴的对齐程度）
- 输出边缘中点、方向、长度等

**FindCenterlineAxesTool**: 中心线查找
- 分析所有可能的中心线（AABB中心、质心等）
- 输出中心线点、方向、描述等

#### 工具输出结构

**滑动方向分析**：
```python
{
    "directions": [
        {
            "direction": [0.0, 1.0, 0.0],
            "axis": "y",
            "magnitude": 1.0,
            "description": "前后滑动",
            "direction_id": "sliding_direction_1",
            "reference_direction_id": "positive_y"
        },
        ...
    ],
    "color_mapping": {...},
    "index_mapping": {...},
    "visualization_path": "draw0_sliding_directions.png"
}
```

**旋转轴分析**：
```python
{
    "axes": [
        {
            "edge_id": "edge_0",  # 或 "axis_id": "x_axis_centerline"
            "midpoint": [0.0, 0.0, 0.5],  # 或 "point": [...]
            "direction": [0.0, 0.0, 1.0],
            "length": 1.0,
            "alignment_axis": "z",
            "alignment_score": 0.95,
            "semantic_info": "垂直边缘"
        },
        ...
    ],
    "color_mapping": {...},
    "index_mapping": {...},
    "visualization_path": "door0_edge_rotation.png"
}
```

---

## 完整数据流示例

### 示例：处理一个旋转门

```
1. 渲染阶段
   XML文件: "双开门冰箱.xml"
   ↓
   RenderOrchestrator.orchestrate_rendering()
   ↓
   生成图像：
   - overall_双开门冰箱.png
   - highlighted_door0.png
   ↓
   存储到记忆系统（rendering_type: "overall", "part_highlighted"）

2. 场景感知阶段
   从记忆系统读取渲染图像
   ↓
   SceneAwarenessAgent.analyze_scene()
   ↓
   LLM分析overall图像 → 场景描述
   ↓
   存储场景描述到记忆系统（memory_category: "scene_description"）
   ↓
   SceneAwarenessAgent.analyze_all_parts_with_memory()
   ↓
   并行分析所有part：
   - 分析door0（overall + highlighted_door0图像）
   - LLM输出：PartAnalysisLLMResponse
   - 创建：PartAnalysisResult(motion_type="rotating", ...)
   ↓
   存储Part分析结果到记忆系统（analysis_type: "part_analysis"）

3. 约束推理阶段
   从记忆系统读取Part分析结果
   ↓
   ConstraintReasoningAgent.reason_motion_constraint(part_name="door0")
   ↓
   判断旋转类型：edge（从motion_description推断）
   ↓
   调用工具：AnalyzeMotionTypeTool(motion_type="edge_rotation")
   ↓
   FindPartEdgesTool分析mesh边缘
   ↓
   生成候选边缘列表（4条边缘，带对齐分数）
   ↓
   生成可视化图像：door0_edge_rotation.png（带颜色编码）
   ↓
   存储可视化图像路径到记忆系统（visualization_type: "axis_analysis"）
   ↓
   从记忆系统读取场景描述
   ↓
   分析空间上下文（开口方向：往外开，+Y方向）
   ↓
   LLM选择（build_axis_selection_prompt）：
   - 输入：overall图像 + highlighted_door0图像 + 可视化图像
   - 输入：候选边缘列表（带序号和语义信息）
   - 输出：AxisSelectionLLMResponse(selected_axis_id="edge_0", index=0)
   ↓
   推理旋转范围：LLM输出90度
   ↓
   创建：MotionConstraintResult(
       rotation_type="edge",
       selected_axis_id="edge_0",
       selected_axis_info={...},
       motion_range=(-90.0, 90.0),
       ...
   )

4. MJCF生成阶段
   MotionConstraintResult列表
   ↓
   MJCFConstraintAgent.generate_constraints()
   ↓
   转换约束方案：
   - MotionConstraintResult → MJCFConstraintPlan
   - 创建MJCFJointSpec(type=HINGE, axis=[0,0,1], pos=[0,0,0.5], range=(-90,90))
   ↓
   修改XML文件：
   - 查找door0的geom和body
   - 创建独立body：door0_body（pos=mesh中心）
   - 添加joint：door0_hinge
   - 添加actuator：door0_hinge_actuator
   ↓
   保存XML文件：result.xml
```

---

## 环境配置

系统使用环境变量管理 API 密钥，支持两种配置方式：

1. **通义千问 API**（推荐）：
   ```env
   QWEN_API_KEY=your_qwen_api_key
   QWEN_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
   ```

2. **OpenAI 兼容 API**：
   ```env
   OPENAI_API_KEY=your_openai_api_key
   OPENAI_BASE_URL=https://api.openai.com/v1
   ```

系统会优先使用 `QWEN_*` 变量，如果未设置则使用 `OPENAI_*` 变量。

详细配置说明请参考项目根目录下的 `.env.example` 文件。

## 快速开始

1. **安装依赖**：
   ```bash
   pip install -r agent/utils/requirements.txt
   ```

2. **配置环境变量**：
   ```bash
   cp .env.example .env
   # 编辑 .env 文件，填入你的 API 密钥
   ```

3. **运行程序**：
   ```bash
   python DEMO/main.py
   ```

## 总结

LinkForge 采用多智能体协作架构，通过记忆系统实现数据共享和持久化。每个智能体都有明确的职责和能力，通过标准化的数据模型和 Prompt 模板实现协作。工具模块提供几何分析能力，支撑约束推理的精确性。整个系统实现了从 3D 模型到 MJCF 约束的完整自动化流程。

### 核心特点

- **模块化设计**：每个智能体独立负责特定任务，易于维护和扩展
- **记忆系统**：持久化存储分析结果，支持跨任务复用
- **多线程并行**：渲染和分析任务支持并行处理，提高效率
- **用户交互**：支持用户提示，提高约束推理的准确性
- **标准化输出**：使用 Pydantic 数据模型，确保数据一致性
- **可视化支持**：生成可视化图像，辅助理解和调试

